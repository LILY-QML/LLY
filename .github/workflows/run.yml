flname: Run DML on Server

on:
  workflow_dispatch: # Ermöglicht das manuelle Starten des Workflows

jobs:
  run-on-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client

      - name: Run Script on Server
        env:
          EXEC_SERVER: ${{ secrets.EXEC_SERVER }}
          EXEC_W: ${{ secrets.EXEC_W }}
        run: |
          sshpass -p "$EXEC_W" ssh -o StrictHostKeyChecking=no root@$EXEC_SERVER << 'EOF'
            # Lösche ggf. alte Version
            rm -rf LLY
            
            # Klone das Repository erneut
            git clone https://github.com/${{ github.repository }}.git LLY
            
            # Wechsel in das Verzeichnis und führe das Python-Skript aus
            cd LLY/example/dml
            python3 main.py
          EOF

      - name: Fetch generated files
        run: |
          sshpass -p "${{ secrets.EXEC_W }}" scp -o StrictHostKeyChecking=no -r root@${{ secrets.EXEC_SERVER }}:/root/LLY/example/dml/* ./generated_files

      - name: Upload generated files as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dml-output
          path: generated_files/
