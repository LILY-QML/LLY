name: Run DML on Server

on:
  workflow_dispatch: # Ermöglicht das manuelle Starten

jobs:
  run-on-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.EXEC_SSH_KEY }}" > private_key
          chmod 600 private_key
          ssh-keyscan -H ${{ secrets.EXEC_SERVER }} >> ~/.ssh/known_hosts

      - name: Run Script on Server
        run: |
          ssh -i private_key root@${{ secrets.EXEC_SERVER }} << 'EOF'
            # Lösche alte Version und klone erneut
            rm -rf LLY
            git clone https://github.com/${{ github.repository }}.git LLY
            cd LLY/example/dml
            python3 main.py
          EOF

      - name: Fetch generated files
        run: |
          scp -i private_key -r root@${{ secrets.EXEC_SERVER }}:/root/LLY/example/dml/* ./generated_files

      - name: Upload generated files as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dml-output
          path: generated_files/
